/*-------------------------*\
|          Jour 11          |
\*-------------------------*/

var input = "#.##########.#########.#########.###.##.#########.######.####.##..####.####.###.##.#######;.####.#.#######.###############..######.#########.######.#######.##########.##############;########.###.####.####.#########.################.######.#########.###.####.##############;#####..##.##.##########################.#########.##############.#######.#########.#######;#####.#.########.#####.################.################.#######.#####.###################;#####..#..#.#........#....#.#..###...#....#.....#...#..#.....###.#..#..###...#.###...#..#.;#####.######.#####################.####.######.##.######.#######.#####.####.##############;#####.######.##################..######.#.###.##################..####.####.######.#######;#####.###.############.################.################.#######.#######.##.##############;######################.########..######.##########.#####.#############.####.######.#.#####;############.#########.################.###..##.##.#############.#####.####.######.#######;#####.#####..#########.#######################.#########..######.#####.####.##############;###.########.###################.######.######.##.######.##.###############.######.#######;.#.##..##.###...#....#..#....###...##.#.#......#.....................####.....#..###.#..#.;######.#####.#####.###.#########.######.######.##.###.##.####.########.###########.#######;############..#.######.#########.################.######.################.########.#######;############.###.#####.#########.#.###..#########.###.##.#######.####..####..##########.##;#####.######.##.###.##.######.##.######.#########.######.######..#####.####.##############;..#...###..#.......#..##.###........#..#..###..#.#.###..##....##.#.#...###...###..##.#...#;#####.######.###################.#######################.#.###########.####.##############;###########..####.##############.#########.#####..######.#######.#####.####.#.############;#####.###.############.######.#..#####..#########.######.#######.#####.###########.#######;#####.#########.######.###########.##############.######.###.###.#####.####.###.##.##.####;#####.######.#########.#########.################.#.####.#######.#################.#######;#####.######.#########.#########.######.###########.####.#######.#####.##############.####;#####.######.########..###.#####.######.#########.######.#######.#####.###########.#######;#####.######..####################.########.#####.######.##################.######.#######;..#..#......#.#...#.....#....#..#.#..#.##.#####....##...#.#.##....#..#..#..............##.;###########..#########.##.######.######.#########.######.##################.#############.;######.#####.#############.#####.######.#########.############.#######.###########.####.##;#####.###############..#######.#.######.##################.######.####..###.###.##.#######;#####.######.#########.##########################.####################.####.######.#######;#####.##.###.#########.######.#########.#########.#.######.################.######.#######;#.......#...........#..#.....#.#.#.....#...#.....##...........#..#.....#.....##......#....;#####.######.#########.################.#########.####################.###########.#######;#####.######.#########.###.############.##.#.#.##########.#.####.###.#############.#######;#####.######.#########.#########.######.################.#######.#####.####.######.#######;####..######.###################.######.########.#######.#######.#####.####.##############;#####.######.#########.################.####.###########.#######.##########.######.#######;.#..#...#.......#....#.....#...........######.#...#..#.#....#.###...##......##.#..#.##..#.;#####.######.#########.################.############.###.#############.####.######.#######;#####.####.#.#########.################.######.##.######..############.###################;#####.##########################.######.######.#######################.#.###.#######.#####;####.##.####.###################.######.#############.##.#######.##########.#######.######;#####.######.###################.######.#########.######.###########.###..#.######.#######;####################.#.##########################.#####..#############.####.######.#######;#.###.######.#########.#.#######..#####..###############.####.##.#####.####.######.#######;#####.#.####.############.######.######.#########..#############.#####.##.#.######.##.####;#####.######.#########.################.#########.######.#######.#####.####.######.##.####;#..#.#.##.###..###.#.#.......#...#.##...#..#.#......#....#.....#..#....#....##.#..........;######################.#########.######.#########.######.#######.##########.######.#######;#####.######.###################.######.###.###############################.####.#.#######;############.##.######.#####.###.##########.############.####.##.#####.####.######.###.###;################################.######.#########.###.###############..####.##############;#####.######.#########.##########################.######.#############.####.######..######;############.#########.################.#########.#.####.######..#####.####.#########.####;.......#....#....#.#....#.####......#.#............#....#..#..#..#.###..#.####.##..#....#.;#####.######.#.#######.#########.######..########.######.##.#.########.####.######.#######;#####.######..##################.######.#########.######.#############.###..##############;#####.###.##.########.##########.###.############.##############..########################;#.###.######.#########.######.##.####.#.#########.###.##########.#####.###.##############.;#######.####.#########.#########.######.#########.##.###.#######.####.############.#######;#####.################.#########.######.#########.######.#############.###.####.#####.####;##...#..##........#...##....#.##..#.........##..#...#..#.#...#.#.##..#.#....##....##.....#;#####.######.########..#########.######.###################################.#.############;#####.######.#########.################.########################.#####.###########.####.##;#####.######.#########.#####.###.####.#.###########.####.#######.#.###.###########.#######;##.##.#########.################.######.##.######.######.###############.##.######.###.###;############.#########.##.######.###############################.######.###.######.#######;###.#.#.####.###################.#.##############.######.#############..###.######.###.###;#.##..#.#.#...#......#...#.......#.#.##.....#.........#....#.......#.##....#..#.#...#....#;#####.################.#########.######.#############..##############.####.###############;#####..#####.#########.#########.######.################.###.###.##########.######.#######;############.#########.####.####.######.#########.####.#.#######.#.###.####.######.###.###;############.####.#############..################.######.#######.#####.####.######.#######;#####.#####..###################.#######.###############.#.################.######.#######;#####.######.######.##.################..########.#######.##.#########.####.###.##########;#####.######.#########.################.#####.###.######.######..#####.####.#.####.######.;#####.#############..#.#########.######.###.#####.######.#######..####.###########.#######;#####.######.#########.#########.################.######.###.###.##########.##############;.##...#...........##...###.#.#.#.#...#.#.....######..........#.#.#.#.#...#.#.#.#........#.;############.#########..########.#.##############.######.##################.#####..#######;#.###.######.#########.###.#####.######.################.#############.###########.######.;###.########.##.######.#.#######.##########.############.#######.#####.####.##############;#########.#.##########.#.#######.####.#.#####################.##.##########.####.#########;#####.#######.#######..####.####.######.#########.######.#######.#####.####.#.###########.;#####.#############.###.#########################.###.##.#######.##########.######.#######;.####.######.###############.###.######.#######.#.##############.####..#.#..######.#######;#####.################.#########.######.#######.#.######.#############.####.######.#######;#####.######..########.####.###.#######.#########.##.###.#############.###########.######.;######################.#########.#######################.#######.#####.####.######..######;#####.######.#########.#########.################..#####.######.############.#############;#.###.######.#########.#########.#.##################.##.##############.##..######.#######";
var layout = input.split(";");

function nextRound() {
	var moves = 0;
	for (var y = 0, yMax = layout.length; y < yMax; ++y) {
		for (var x = 0, xMax = layout[0].length; x < xMax; ++x) {
			if (layout[y][x] == "L") {
				if (checkAround(x, y) == 0) {
					layout[y] = layout[y].replaceChar(x, "O");
					moves++;
				}
			}
			if (layout[y][x] == "#") {
				if (checkAround(x, y) >= 4) {
					layout[y] = layout[y].replaceChar(x, "-");
					moves++;
				}
			}
		}
	}
	return (moves == 0);
}

function checkAround(x, y) {
	var occupied = 0;
	for (var locY = y -1, locYMax = y + 1; locY <= locYMax; ++locY) {
		for (var locX = x -1, locXMax = x + 1; locX <= locXMax; ++locX) {
			if ((locY >= 0) && (locY < layout.length) && (locX >= 0) && (locX < layout[0].length)) {
				if (!((locX == x) && (locY == y))) {
					if (layout[locY][locX].match(/[#\-]/)) {
						occupied++;
					}
				}
			}
		}
	}
	return occupied;
}

String.prototype.replaceChar = function(pos, newChar) {
    return this.substr(0, pos) + newChar + this.substr(pos + 1);
}

var noMoreMoves = false;
do {
	noMoreMoves = nextRound();
	for (var row in layout) {
		layout[row] = layout[row].replaceAll("-", "L").replaceAll("O", "#");
	}
}
while(!noMoreMoves);

var occupied = 0;
for (var y of layout) {
	for (var x of y) {
		if (x == "#") {
			occupied++;
		}
	}
}
console.log("Part 1 : " + occupied);

//part 2

function nextRound2() {
	var moves = 0;
	for (var y = 0, yMax = layout.length; y < yMax; ++y) {
		for (var x = 0, xMax = layout[0].length; x < xMax; ++x) {
			if (layout[y][x] == "L") {
				if (checkAround2(x, y) == 0) {
					layout[y] = layout[y].replaceChar(x, "O");
					moves++;
				}
			}
			if (layout[y][x] == "#") {
				if (checkAround2(x, y) >= 5) {
					layout[y] = layout[y].replaceChar(x, "-");
					moves++;
				}
			}
		}
	}
	return (moves == 0);
}

function checkAround2(x, y) {
	var occupied = 0;
	var trajectories = [
		[0, -1],
		[1, -1],
		[1, 0],
		[1, 1],
		[0, 1],
		[-1, 1],
		[-1, 0],
		[-1, -1]
	];
	for (var t of trajectories) {
		var seatFound = "";
		var tx = x;
		var ty = y;
		do {
			seatFound = "";
			tx += t[0];
			ty += t[1];
			if ((tx >= 0) && (ty >= 0) && (tx < layout[0].length) && (ty < layout.length)) {
				seatFound = layout[ty][tx];
			}
		}
		while(seatFound == ".");
		
		if (seatFound.match(/[#\-]/)) {
			occupied++;
		}
	}
	return occupied;
}

layout = input.split(";");
noMoreMoves = false;
do {
	noMoreMoves = nextRound2();
	for (var row in layout) {
		layout[row] = layout[row].replaceAll("-", "L").replaceAll("O", "#");
	}
}
while(!noMoreMoves);

occupied = 0;
for (var y of layout) {
	for (var x of y) {
		if (x == "#") {
			occupied++;
		}
	}
}
console.log("Part 2 : " + occupied);

